{"version":3,"file":"topic.js","sourceRoot":"","sources":["../../src/core/topic.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  AbstractTopic, TopicOptions,\n  MarkerOptions, ImageOptions\n} from '../abstracts/topic.abstract';\nimport { SummaryOptions } from '../abstracts/summary.abstract';\nimport { Summary } from './summary';\nimport { Note } from './note';\nimport { isEmpty, isObject, isString } from '../utils/common';\n\nimport * as Model from '../common/model';\nimport * as Core from 'xmind-model';\nimport Base from './base';\n\n\n/**\n * @description Topic common methods\n */\nexport class Topic extends Base implements AbstractTopic {\n  private readonly sheet: Core.Sheet;\n  private readonly root: Core.Topic;\n\n  private parentId: string;\n  private lastId: string;\n\n  constructor(options: TopicOptions = <TopicOptions>{}) {\n    super({debug: 'xmind-sdk:topic'});\n    if (options && !options.sheet) {\n      throw new Error('options.sheet is required');\n    }\n\n    this.sheet = options.sheet;\n    this.root = this.sheet.getRootTopic();\n    this.parentId = this.lastId = this.root.getId();\n    this.setRoot({ id: this.parentId, title: 'Central Topic' });\n  }\n\n  public on(componentId?: string): Topic {\n    if (!componentId) {\n      this.parentId = this.root.getId();\n      return this;\n    }\n\n    if (!this.isValidComponentId(String(componentId))) {\n      throw new Error(`Invalid componentId ${String(componentId)}`);\n    }\n\n    this.parentId = componentId;\n    return this;\n  }\n\n  public addLabel(text: string): Topic {\n    const p = this.parent();\n    const labels = p.getLabels();\n    const options = { index: 0 };\n    if (!labels || labels.length === 0) {\n      options.index = 0;\n    } else {\n      options.index = labels.length;\n    }\n    p.addLabel(text, options);\n    return this;\n  }\n\n  public removeLabel(componentId?: string): Topic {\n    const p = componentId ? this.find(componentId) : this.parent();\n    if (!p) {\n      throw new Error(`does not found component: ${componentId}`);\n    }\n    p.removeLabels();\n    return this;\n  }\n\n  public add(topic: Model.Topic & {\n    customId?: string | number, parentId?: string\n  } = {} as any, options?: { index: number }): Topic {\n    if (!isString(topic.title)) {\n      throw new Error('topic.title should be a valid string');\n    }\n    topic.id = topic.id || this.id;\n    this.parent().addChildTopic(topic, options);\n    this.addChildNode({\n      id: topic.id, title: topic.title,\n      customId: topic.customId || null,\n      parentId: topic.parentId || this.parentId\n    });\n    this.lastId = topic.id;\n    return this;\n  }\n\n  public image(options?: ImageOptions): string {\n    const dir = `resources/${this.id}`;\n    const params = Object.assign({}, {src: `xap:${dir}`}, options || {});\n    this.parent().addImage(params);\n    return dir;\n  }\n\n  public note(text: string, del?: boolean): Topic {\n    const p = this.parent();\n    if (del === true) {\n      p.removeNotes();\n      return this;\n    }\n    if (!text) return this;\n    const n = new Note();\n    n.text = text;\n    p.addNotes(n.toJSON());\n    return this;\n  }\n\n  public destroy(componentId: string): Topic {\n    if (!this.isValidComponentId(componentId)) {\n      this.debug('E - target: \"%s\" does not exist', componentId);\n      return this;\n    }\n    try {\n      const topic = this.find(componentId);\n      topic.parent().removeChildTopic(topic);\n      this.destroyNode({ id: componentId });\n    } catch (e) {\n      /* istanbul ignore next */\n      this.debug('D - %s', e.message);\n    }\n    return this;\n  }\n\n  public summary(options: SummaryOptions = <SummaryOptions>{}): Topic {\n    if (this.parent().isRootTopic()) {\n      this.debug('I - Not allowed add summary on root topic.');\n      return this;\n    }\n\n    let edge = null;\n    if (options.edge) {\n      if (this.exist(options.edge)) {\n        edge = options.edge;\n      } else {\n        this.debug('W - Topic \"%s\" does not exist', options.edge);\n      }\n    }\n\n    const summary = new Summary();\n    const type = this.parent().getType();\n    const grandfather = this.grandfather();\n    const children = grandfather.getChildrenByType(type);\n    const condition = [this.parentId, !edge ? this.parentId : edge];\n    summary.range({ children, condition });\n    const summaryOptions = {title: options.title || 'Summary', id: this.id};\n    summary.topicId = summaryOptions.id;\n    grandfather.addSummary(summary.toJSON(), summaryOptions);\n    this.addChildNode({\n      id: summaryOptions.id, title: summaryOptions.title,\n      parentId: this.parentId\n    });\n    this.lastId = summaryOptions.id;\n    return this;\n  }\n\n  public marker(options: MarkerOptions = <MarkerOptions>{}): Topic {\n    if (\n      !isObject(options) || isEmpty(options) ||\n      !options['groupId'] || !options['markerId']\n    ) {\n      this.debug('E - Invalid marker options: %j', options);\n      return this;\n    }\n\n    if (options.del === true) {\n      delete options.del;\n      this.parent().removeMarker(options);\n      return this;\n    }\n\n    this.parent().addMarker(options);\n    return this;\n  }\n\n\n  public cid(title?: string, dependencies: {\n    parentId?: number | string, customId?: number | string\n  } = {}): string | null {\n    const validTitle = isString(title);\n    if (validTitle && dependencies) {\n      if (dependencies.parentId) {\n        return this.getConflictedComponentId({\n          title, parentId: dependencies.parentId\n        });\n      }\n      if (dependencies.customId) {\n        return this.getConflictedComponentId({\n          title, customId: dependencies.customId\n        });\n      }\n    }\n\n    if (validTitle) {\n      return this.findComponentIdBy(title);\n    }\n    return this.lastId;\n  }\n\n  public cids(): Record<string, string> {\n    return this.all();\n  }\n\n  public find(componentId: string = null) {\n    const rootId = this.root.getId();\n\n    if (!componentId || componentId === rootId) {\n      return this.root;\n    }\n\n    return this.sheet.findComponentById(componentId);\n  }\n\n  private grandfather() {\n    return this.parent().parent();\n  }\n\n  private parent() {\n    return this.parentId === this.root.getId() ?\n      this.root :\n      this.sheet.findComponentById(this.parentId);\n  }\n\n  get rootTopic() {\n    /* istanbul ignore next */\n    return this.root;\n  }\n\n  get rootTopicId() {\n    return this.root.getId();\n  }\n}\n"]}